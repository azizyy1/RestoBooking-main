@model ProfileViewModel
@{
    ViewData["Title"] = "Mon profil";
}

<section class="profile-hero">
    <div class="profile-hero__content container">
        <div>
            <p class="profile-hero__kicker">Espace client</p>
            <h1 class="profile-hero__title">Bonjour, @Model.DisplayName</h1>
            <p class="profile-hero__subtitle">Retrouvez vos informations, vos réservations et vos factures en un seul
                endroit.</p>
        </div>
        <div class="profile-hero__actions">
            <form asp-area="Identity" asp-page="/Account/Logout" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-light me-2">Se déconnecter</button>
            </form>
            <a asp-controller="Reservation" asp-action="Create" class="btn btn-primary">Nouvelle réservation</a>
        </div>
    </div>
</section>

<section class="container profile-grid">
    <div class="profile-card">
        <div class="profile-card__header">
            <h2>Mes informations</h2>
            <span class="badge rounded-pill text-bg-dark">Profil</span>
        </div>
        <ul class="profile-info">
            <li>
                <span>Nom d'utilisateur</span>
                <strong>@Model.DisplayName</strong>
            </li>
            <li>
                <span>Email</span>
                <strong>@Model.Email</strong>
            </li>
            <li>
                <span>Téléphone</span>
                <strong>@(string.IsNullOrWhiteSpace(Model.PhoneNumber) ? "Non renseigné" : Model.PhoneNumber)</strong>
            </li>
        </ul>
    </div>

    <div class="profile-card profile-card--reservations">
        <div class="profile-card__header">
            <h2>Mes réservations</h2>
            <div class="d-flex align-items-center gap-2">
                <span class="badge rounded-pill text-bg-primary">@Model.Reservations.Count</span>
                <span class="text-muted small">réservation(s)</span>
            </div>
        </div>

        @if (!Model.Reservations.Any())
        {
            <div class="empty-state">
                <p>Vous n'avez pas encore de réservation.</p>
                <a asp-controller="Reservation" asp-action="Create" class="btn btn-outline-light">Réserver une table</a>
            </div>
        }
        else
        {
            <div class="reservation-list">
                @foreach (var reservation in Model.Reservations)
                {
                    <article class="reservation-item">
                        <div class="reservation-item__header">
                            <div>
                                <p class="reservation-item__date">@reservation.ReservationDate.ToString("dd MMMM yyyy à HH:mm")
                                </p>
                                <h3 class="reservation-item__title">@reservation.TableName <span
                                        class="text-muted">(@reservation.TableCategoryLabel)</span></h3>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                @if (reservation.IsCancelled)
                                {
                                    <span class="badge rounded-pill text-bg-danger">Annulée</span>
                                }
                                else if (reservation.IsUpcoming)
                                {
                                    <span class="badge rounded-pill text-bg-success">À venir</span>
                                }
                                else
                                {
                                    <span class="badge rounded-pill text-bg-secondary">Passée</span>
                                }
                            </div>
                            <div class="reservation-item__total">
                                <span>Total</span>
                                <strong>@reservation.TotalPrice.ToString("0.00") DH</strong>
                            </div>
                        </div>

                        <div class="reservation-item__details">
                            <div>
                                <p class="label">Nombre de personnes</p>
                                <strong>@reservation.NumberOfPeople</strong>
                            </div>
                            <div>
                                <p class="label">Occasion</p>
                                <strong>@reservation.OccasionLabel</strong>
                            </div>
                            <div>
                                <p class="label">Notes</p>
                                <strong>@(string.IsNullOrWhiteSpace(reservation.Notes) ? "—" : reservation.Notes)</strong>
                            </div>
                        </div>

                        <div class="invoice">
                            <p class="label mb-2">Facture détaillée</p>
                            <ul class="invoice__items">
                                <li>
                                    <span>Table (@reservation.TableCategoryLabel)</span>
                                    <span>@reservation.TablePricePerPerson.ToString("0.00") DH / personne</span>
                                </li>
                                <li>
                                    <span>Occasion (@reservation.OccasionLabel)</span>
                                    <span>@reservation.OccasionPricePerPerson.ToString("0.00") DH / personne</span>
                                </li>
                                <li>
                                    <span>Nombre de personnes</span>
                                    <span>@reservation.NumberOfPeople</span>
                                </li>
                                <li class="invoice__total">
                                    <span>Total TTC</span>
                                    <strong>@reservation.TotalPrice.ToString("0.00") DH</strong>
                                </li>
                            </ul>
                        </div>

                        @if (reservation.IsCancelled)
                        {
                            <div class="alert alert-warning mb-3" role="alert">
                                <strong>Annulation enregistrée</strong><br />
                                Frais (5%) : @reservation.CancellationFee.ToString("0.00") DH – Montant remboursé :
                                @reservation.RefundAmount.ToString("0.00") DH<br />
                                @if (reservation.CancelledAt.HasValue)
                                {
                                    <span class="text-muted">Annulé le @reservation.CancelledAt.Value.ToLocalTime().ToString("dd/MM/yyyy à HH:mm")</span>
                                }
                            </div>
                        }

                        <div class="reservation-item__actions">
                            @if (reservation.IsCancelled)
                            {
                                <span class="badge rounded-pill text-bg-danger">Réservation annulée</span>
                            }
                            else if (reservation.IsUpcoming)
                            {
                                <form asp-action="Cancel" method="post">
                                    <input type="hidden" name="id" value="@reservation.Id" />
                                    <button type="submit" class="btn btn-outline-danger"
                                        onclick="return confirm('Voulez-vous annuler cette réservation ? Des frais de 5% seront appliqués.');">
                                        Annuler
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="badge rounded-pill text-bg-secondary">Passée</span>
                            }
                        </div>
                    </article>
                }
            </div>
        }
    </div>
</section>

@if (TempData["StatusMessage"] is string status)
{
    <div class="alert alert-success mt-4 container" role="alert">
        @status
    </div>
}